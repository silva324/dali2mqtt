version: '3.8'

services:
  dali2mqtt:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: dali2mqtt
    restart: unless-stopped
    
    # Required for USB device access
    privileged: true
    
    volumes:
      # Configuration
      - ./config:/app/config:rw
      # Device names persistence
      - ./data:/app/data:rw
      # USB device access
      - /dev:/dev:rw
    
    environment:
      # MQTT Configuration (override in .env file)
      - MQTT_SERVER=${MQTT_SERVER:-localhost}
      - MQTT_PORT=${MQTT_PORT:-1883}
      - MQTT_USERNAME=${MQTT_USERNAME:-}
      - MQTT_PASSWORD=${MQTT_PASSWORD:-}
      - MQTT_BASE_TOPIC=${MQTT_BASE_TOPIC:-dali2mqtt}
      
      # DALI Configuration
      - DALI_DRIVER=${DALI_DRIVER:-hid_hasseb}
      - DALI_LAMPS=${DALI_LAMPS:-64}
      
      # Home Assistant Integration
      - HA_DISCOVERY_PREFIX=${HA_DISCOVERY_PREFIX:-homeassistant}
      
      # Logging
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - LOG_COLOR=${LOG_COLOR:-false}
    
    # Use host network for easier MQTT connectivity
    # Alternative: use bridge network and expose ports if needed
    network_mode: host
    
    # Device mapping (alternative to privileged mode)
    # Uncomment and adjust if you want to be more restrictive
    # devices:
    #   - /dev/hidraw0:/dev/hidraw0
    #   - /dev/bus/usb:/dev/bus/usb
    
    labels:
      - "com.dali2mqtt.description=DALI to MQTT Bridge"
      - "com.dali2mqtt.version=1.0"

# Optional: Use a dedicated network instead of host mode
# networks:
#   dali_network:
#     driver: bridge
